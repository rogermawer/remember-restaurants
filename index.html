<!DOCTYPE html>
<!-- designed by mangomeat.com 2018-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mangomeat</title>
    <meta name="description" content="Custom, professional web design">
    <meta name="keywords" content="">
      
    <!-- Fonts -->  
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link href="/css/fontawesome-free-5.11.2-web/css/all.css" rel="stylesheet">
    
    <!-- custom style -->
    <link href="/css/style.css" rel="stylesheet">
    
    <!-- scripts -->
    <script src="/js/jquery-v3.3.1.js"></script>

    
   
<style>
    
</style>
  
<script>
var bizSearchResults; //store api call result here to prevent recalls
$(document).ready(function(){
    const url = '/search';
    $('#submit').click(function(e){
        e.preventDefault();
        hideShowSearchSpinner(); // start spinner
    
        $('#result .content').empty(); //clear items in result div 
        var searchTerm = {
        restaurant: $('input[name="restaurant"]').val(),
        location: $('input[name="location"]').val()
        };
        
        if (searchTerm.location.length > 1) {
            $.post(url, searchTerm)
                .done(function(result){
                    openLeftNav();
                    // if no results...
                    if (result.length < 1){
                        $("#result .content").html(`Didn't find any results for that.`);
                    }else{
                        //otherwise...
                        bizSearchResults = result;
                        storeBusinessinResults(bizSearchResults);
                    }
                    hideShowSearchSpinner(); //stop spinner
                })
                // handle server side rejections...
                .fail(function(xhr, status, error){
                    $("#result .content").html(`Server rejected input. Status ${xhr.status}`);
                    openLeftNav();
                    hideShowSearchSpinner(); //stop spinner
                }) 
        }else{
            $("#result .content").html(`Try entering a location when you search.`);
            setTimeout(openLeftNav, 100); // work around to open side nav before close is called.
            hideShowSearchSpinner(); //stop spinner
        }
    }) 
    
$('#sort-rating').click(function(){
    $('#result .content').empty();
    var results = sortByRating(bizSearchResults);
    storeBusinessinResults(results);
})
$('#sort-distance').click(function(){
    $('#result .content').empty();
    console.log(bizSearchResults)
    var results = sortByDistance(bizSearchResults);
    storeBusinessinResults(results);
})
$('#random-saved').click(function(){
    $('#saved .content').empty();
    randomPick(getSavedBusinesses());
})

});
   
    
const showWindow = (e) => {
    $(e).parent().css('width', '0');
}

const hideWindow = (e) => {
    $(e).parent().css('width', '0');
}   
    

</script>
</head>
    
<body>
<!--
<div id="sidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="#">Log Out</a>
</div>
<span onclick="openMenuNav()" id="menu-icon"><i class="fas fa-bars"></i></span>
-->
<div class="toolbar">
    <ul class="menu">
        <li onclick="openLeftNav()" id='expand-results'>SEARCH</li>
        <li onclick="openRightNav()" id='expand-saved'>REMEMBER</li>
    </ul>
</div>
    
<div class="nav" id="result">
    <div class="side-menu">
      <button id="sort-distance" class="generic-button utility">Sort by Distance</button>
      <button id="sort-rating" class="generic-button utility">Sort by Rating</button>
    </div>
    <div class="content"><p>Try searching for something!</p></div>
</div>
        
<div class="nav" id="saved">
    <div class="side-menu">
        <button id="random-saved" class="generic-button utility">Random Pick</button>
    </div>
    <div class="content" style="padding-top:40px"></div>
</div>
    
    
<div class="height-100" onclick="closeNav()">
    
    <div class="flexin height-100">
        
      <div class="main-contain-centered">
          
          <div class="form-container">
            <h1 class="business-title">remember a restaurant</h1>
            <form id="search-form" class="searchForm" method="POST" action="/search">
              <input type="text" name="restaurant">
              <input id="location" type="text" placeholder="enter a location" value="" name="location">
              </form>
              
              <div style="width: 200px;justify-content: center;display: flex">
                  <button id="submit" class="generic-button" value="Submit!" form="search-form" type="submit"><i class="fas fa-search hidden"></i><i class="fas fa-spinner fa-pulse"></i></button>
                  <button id="find-me" class="generic-button utility" style="width: 20%;"><i class="fas fa-map-marker-alt"></i></button>
              </div>
          </div>
          
      </div>
    </div>
</div>

  
                

      
<script>
    
//sorting functions
const sortByRating = (bizSearchResults) => {
    return Array.from(bizSearchResults).sort((high ,low) => low.rating - high.rating);
}
const sortByDistance = (bizSearchResults) => {
    return Array.from(bizSearchResults).sort((close ,far) => close.distance - far.distance);
}

const randomPick = (savedBusinesses) => {
    var randomSelect = savedBusinesses[Math.floor(Math.random() * (savedBusinesses.length - 0))];
    storeBusinessinSaved(Array(randomSelect))
}



// pretty format functions
const printLocation = (array) => {
    var printedAddress = "";
    $.each(array, function(i, val){
        printedAddress+=` ${val}`;
    })
    return printedAddress;
}

const printCategories = (array) => {
    var printedCategories = "";
    $.each(array, function(i, val){
        printedCategories+=`${val.title}, `;
    })
    return printedCategories;
}


//for results side. displays businesses after search
const storeBusinessinResults = (business) => {
    business.forEach(function(val){
        var locationArray = val.location.display_address;
        var categoriesArray = val.categories;
        var businessName = `<h1 class="business-title" id="biz-title">${val.name}</h1>`;
        var businessCategories = `<p id="biz-categories">${printCategories(categoriesArray)}</p>`;
        var businessLocation = `<p id="biz-location">${printLocation(locationArray)}</p>`;
        var businessImage = `<p><img id="biz-img" class="img-contain" src=${val.image_url}></p>`;
        var businessRating = `<p>Rating: ${val.rating}</p>`;
        var saveBusiness = `<div class="flexin"><button class="save-button generic-button" onclick="saveBusiness(this, bizSearchResults)">Save this place.</button>`;
        var navigateButton = `<button class="navigate-button generic-button utility" data-location="${printLocation(locationArray)}" onclick="openBusinessInMaps(this)"><i class="far fa-map"></i></button></div>`;
        //
        return ($("#result .content").append(`<div class="businesses" data-bizid=${val.id}>${businessName}${businessCategories}${businessLocation}${businessImage}${businessRating}${saveBusiness}${navigateButton}</div>`))
    })
}

// get items in local storage, return array
const getSavedBusinesses = () => {
    var savedBusinesses;
    if ('businesses' in localStorage){
        savedBusinesses = JSON.parse(localStorage.getItem('businesses'));
    }else{
        savedBusinesses = [];
    }
    return savedBusinesses;
}

// display items from local storage for saved side. also adds newly saved businesses. arg is array
const storeBusinessinSaved = (bizArray) => {
    bizArray.forEach(function(i){
        var businessName = `<h1 class="business-title">${i.name}</h1>`;
        var businessCategories = `<p>${i.categories}</p>`;
        var businessLocation = `<p>${i.location}</p>`;
        var businessImage = `<p><img class="img-contain" src=${i.img}></p>`;
        var navigateButton = `<div class="flexin"><button class="navigate-button generic-button utility" onclick="openBusinessInMaps(this)" data-location="${i.location}"><i class="far fa-map"></i></button>`;
        var removeBusiness = `<button class="remove-button generic-button" onclick="removeBusiness(this)">Remove</button></div>`;
        //
        return ($("#saved .content").append(`<div class="businesses" data-bizid="${i.id}">${businessName}${businessCategories}${businessLocation}${businessImage}${navigateButton}${removeBusiness}</div>`));
    });
}

// location functions //
const insertAddress = (lat, long) => {
    //return printed address from mapquest api
    var currentLocationString = "";
    var url = `https://www.mapquestapi.com/geocoding/v1/reverse?key=IAgZTUY6CHjddilw58OA0RkulD9TIhNF&location=${lat},${long}`;
    $.ajax({
        url: url,
        success: function(response){
            currentLocationString = `${response.results[0].locations[0].street}, ${response.results[0].locations[0].adminArea5}, ${response.results[0].locations[0].adminArea3}`;
            $('#location').attr('placeholder', 'enter location'); //reset placeholder
            $("#location").val(currentLocationString);
            // remove loading gif
            hideShowSearchSpinner();
        },
        error: function(){
            alert('error!')
        }
    })
}    

const locationSuccess = (position) => {
    // return a city/state string from lat and long
    var lat = position.coords.latitude;
    var long = position.coords.longitude;
    insertAddress(lat, long);

}
const locationError = (error) => {
    if (error.code === 1) { //user denied location
        alert(`For best results, you should enable browser location.`)
    }else if (error.code === 2) { //network error
        alert(`Could'nt connect to network. Is WIFI on?`)
    } else {
        alert(`Couldn't get location data.`)
    }
    document.getElementById('location').setAttribute('placeholder', 'could not find location');
    hideShowSearchSpinner();
}

const findMe = () => {
    document.getElementById('location').setAttribute('placeholder', 'finding location...');
    navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
}

const hideShowSearchSpinner = () => {
    var array = Array.from(document.getElementById('submit').children);
    array.forEach(function(element){
        element.classList.toggle('hidden')
    })
}

document.getElementById('find-me').addEventListener('click', function(){
    hideShowSearchSpinner();
    findMe();
});





// make sure to retrieve saved data from local storage on page load
window.onload = function(){
    storeBusinessinSaved(getSavedBusinesses());
}

//get current location on load
findMe();
    
//add business to localstorage & display in save column
const saveBusiness = (event, searchResults) => {
    var data = {
        'id' : event.parentElement.parentElement.getAttribute('data-bizid'),
        'name': event.parentElement.parentElement.querySelector('#biz-title').innerHTML,
        'categories': event.parentElement.parentElement.querySelector('#biz-categories').innerHTML,
        'location': event.parentElement.parentElement.querySelector('#biz-location').innerHTML,
        'img': event.parentElement.parentElement.querySelector('#biz-img').getAttribute('src')
    }
    var savedBusinesses = getSavedBusinesses();
    var doesBizExist = savedBusinesses.filter(index => index.id == data.id);
    if (doesBizExist.length <= 0){
        //if doesnt exists then save it.
        savedBusinesses.push(data); 
        storeBusinessinSaved(Array(data))//need to convert to array to fit the function
        localStorage.setItem('businesses', JSON.stringify(savedBusinesses));
        alert('saved! wahoo!');
    }else{
        alert('you already saved this place.')
    }
}

const removeBusiness = (domElement) => {
    var businessToRemove = domElement.parentElement.parentElement;
    var localStorageArray = getSavedBusinesses();
    //returns array of businesses after removal
    var updatedBusinessList = localStorageArray.filter(index => index.id != businessToRemove.getAttribute('data-bizid'));
    //remove from DOM
    businessToRemove.remove();
    //reset local storage
    localStorage.setItem('businesses', JSON.stringify(updatedBusinessList))
}

const openBusinessInMaps = (event) => {
    window.open(`https://www.google.com/maps/place/${event.getAttribute('data-location')}`)
}




// for dev... clear localstorage
const clearLocalStorage = () => {
    localStorage.clear();
    return ('local storage cleared')
}
</script>

    
<!-- DOM javascript -->
<script>
function closeNav() {
    document.getElementById("result").classList.remove('opened');
    document.getElementById("saved").classList.remove('opened');
}
function openLeftNav() {
  document.getElementById("result").classList.toggle('opened');
}
function openRightNav() {
  document.getElementById("saved").classList.toggle('opened');
}

</script>
      
    
    
    
    
</body>
</html>