<!DOCTYPE html>
<!-- designed by mangomeat.com 2018-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mangomeat</title>
    <meta name="description" content="Custom, professional web design">
    <meta name="keywords" content="">
    
    <link rel="stylesheet" type="text/css" href="">
      
    <!-- Fonts -->  
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
      
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/push.js"></script>
      <script src="js/serviceWorker.min.js"></script>
    
   
<style>
    html, body {
        font-family: 'Roboto', sans-serif;
        font-weight: 300;
        height:100%;
        margin: 0;
        padding: 0;
        background: rgb(58, 58, 58)
    }
    input, button{
        font-family: 'Roboto', sans-serif;
        font-weight: 400;
    }
    p, button{
        font-family: 'Roboto', sans-serif;
        font-weight: 300;
        margin:0;
        padding:0;
    }
    h1{
        font-weight: 300
    }
    .container{
        height: 100%
    }
    .flex-container{
        height: 100%;
        display: flex;
        flex-direction: row;
    }
    .form-container{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    .main-contain-centered{
        flex-grow: 1;
        align-items: center;
        flex-direction: column;
        justify-content: center;
    }
    .searchForm {
        width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center
    }
    .searchForm input {
        width:100%;
        height:20px;
        margin-top:1em;
        margin-bottom:1em
    }
    #submit {
        width:50%;
        border:none;
        cursor:pointer;
        background-color: yellow;
    }

    /* nav style */
    
    .nav{
        position: absolute;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow-y:scroll;
        width:50%;
    }
    .loading{
        line-height: 0px;
    }
    
    .content{
        padding:20px;
    }
    
    .img-contain{
        width:100%;
        max-width: 600px;
        max-height: 600px;
        object-fit: cover;
    }
    i{
        font-size: 20px;
        line-height: 0px;
        
    }
    
    .save-button{
        padding: 5px 10px 5px 10px;
        background-color: yellow;
    }
    .navigate-button{
        padding: 5px 10px 5px 10px;
        background-color: #8fb57e;
    }
    .align-right {
        margin-left: auto
    }
    .generic-button{
        padding:10px 5px 10px 5px;
        border-radius: 5px;
        margin-bottom: 10px;
        border: none;
        height: 40px;
        font-size: 15px;
        margin-left: 2px
    }
    .hidden{
        display: none!important
    }
    .showSideWindow{
        width:50%!important;
    }
    #result{
        background-color:#eeeeee;
        width:0;
        background: rgba(75, 75, 75, 0.8);
        color: #fff;
        transition: .2s
    }
    #saved{
        background-color: #eeeeee;
        right:0;
        width:0;
        background: rgba(75, 75, 75, 0.8);
        color: #fff;
        transition: .2s
    }
    .business-title{
        color: #F84343
    }
    
    .expand-button{
        flex-direction: row;
        width:75px;
    }
    .remove-button{
        background-color: #F84343;
        color: #eeeeee
    }
    .side-menu{
        display: flex;
        flex-flow: row;
        justify-content: flex-end;
        padding-top:10px
    }
    
    .menu {
        position: absolute;
        display: flex;
        flex-direction: row;
        right:0;
        list-style:none;
        margin:0;
        padding:10px;
    }
    .menu li{
        border:1px solid black;
        border-radius: 5px;
        color: black;
        background-color: yellow;
        padding: 10px 10px 10px 10px;
    }
    .businesses{
        display: flex;
        flex-flow: column;
    }
</style>
  
<script>
var bizSearchResults; //store api call result here to prevent recalls
$(document).ready(function(){
    const url = '/search';
    $('#submit').click(function(e){
        e.preventDefault();
        
        // TODO add loading icon
        
        // open the hidden window
        $('#result').toggleClass('showSideWindow')
        $('#result .content').empty(); //clear items in result div EXCEPT the button to close so new search appears at top
        var searchTerm = {
        restaurant: $('input[name="restaurant"]').val(),
        location: $('input[name="location"]').val()
        };
        $.post(url, searchTerm, function(result){
            // if didnt find results for search...
            try{
                if (result.length < 1){
                    $("#result .content").html(`Didn't find any results for that.`)
                }else{
                //otherwise...
                bizSearchResults = result;
                storeBusinessinResults(bizSearchResults);
                }
            }catch(error){
                $("#result .content").html(`Couldn't find your location. Try typing in an address or city?`)
            }
        })
    }) 
    
$('#sort-rating').click(function(){
    $('#result .content').empty();
    var results = sortByRating(bizSearchResults);
    storeBusinessinResults(results);
})
$('#sort-distance').click(function(){
    $('#result .content').empty();
    var results = sortByDistance(bizSearchResults);
    storeBusinessinResults(results);
})


    
const locationSuccess = (position) => {
    // return a city/state string from lat and long
    var lat = position.coords.latitude;
    var long = position.coords.longitude;
    insertAddress(lat, long);

}
const locationError = () => {
    $('#submit').children().toggleClass('hidden');
}

const insertAddress = (lat, long) => {
    //return printed address from mapquest api
    var currentLocationString = "";
    var url = `https://www.mapquestapi.com/geocoding/v1/reverse?key=IAgZTUY6CHjddilw58OA0RkulD9TIhNF&location=${lat},${long}`;
    $.ajax({
        url: url,
        success: function(response){
            currentLocationString = `${response.results[0].locations[0].street}, ${response.results[0].locations[0].adminArea5}, ${response.results[0].locations[0].adminArea3}`;
            $("#location").val(currentLocationString);
            // remove loading gif
            $('#submit').children().toggleClass('hidden');
        }
    })
}    
    
const findMe = () => {
    navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
}

findMe(); //get current location on load
    
//or when DOM button is clicked
$('#find-me').click(function(){
    $('#submit').children().toggleClass('hidden');
    findMe();
})
    
// hide/show results and saved

$('#expand-results').click(function(){
    $('#result').toggleClass('showSideWindow')
});                       
$('#expand-saved').click(function() {
    $('#saved').toggleClass('showSideWindow')
    });
    
    

//push notices

$('#find-me').click(function(){
    setTimeout(function(){
        Push.create('found you.')
},5000);
});

});
   
    
const showWindow = (e) => {
    $(e).parent().css('width', '0');
}

const hideWindow = (e) => {
    $(e).parent().css('width', '0');
}   
    
// hides parent element of selected (clicked) element. 'e' is 'this'
// const hideWindow = (e) => {
//    $(e).parent().toggleClass('hidden');
//}   
 



</script>
</head>
    
<body>
<div class="container">
    
    <div class="flex-container">
        
      <div class="nav" id="result">
          <div class="side-menu">
            <button id="sort-distance" class="generic-button">Sort by Distance</button>
            <button id="sort-rating" class="generic-button">Sort by Rating</button>
          </div>
        <div class="content">
            
        </div>
      </div>
        
      <div class="nav" id="saved">
<!--          <button onclick="hideWindow(this)" class="save-button close">X</button>-->
        <div class="content" style="padding-top:40px">
          
        </div>
      </div>
        
      <div class="main-contain-centered">
          <div class="toolbar">
              <ul class="menu">
                  <li id='expand-results'>SEARCH</li>
                  <li id='expand-saved'>REMEMBER</li>
              </ul>
          </div>
          <div class="form-container">
            <h1 class="business-title">remember a restaurant</h1>
            <form class="searchForm" method="POST" action="/search">
              <input type="text" name="restaurant">
              <input id="location" type="text" value="" name="location">
            </form>
              
              <div style="width: 200px;justify-content: center;display: flex">
                  <button id="submit" class="generic-button" value="Submit!" type="submit"><i class="fas fa-search hidden"></i><i class="fas fa-spinner fa-pulse"></i></button>
                  <button id="find-me" class="generic-button" style="width: 20%;background-color: #8fb57e"><i class="fas fa-map-marker-alt"></i></button>
              </div>
          </div>
          
      </div>
    </div>
</div>

  
                

      
<script>
    // navigation/location functions
//use mapquest api to reverse geocode: http://www.mapquestapi.com/geocoding/v1/reverse?key=KEY&location=30.333472,-81.470448

    //sorting functions
const sortByRating = (bizSearchResults) => {
    return Array.from(bizSearchResults).sort((h ,l) => l.rating - h.rating);
}
const sortByDistance = (bizSearchResults) => {
    return Array.from(bizSearchResults).sort((c ,f) => c.distance - f.distance);
}




    
// core functions   
const printLocation = (array) => {
    var printedAddress = "";
    $.each(array, function(i, val){
        printedAddress+=` ${val}`;
    })
    return printedAddress;
}

const printCategories = (array) => {
    var printedCategories = "";
    $.each(array, function(i, val){
        printedCategories+=`${val.title}, `;
    })
    return printedCategories;
}
//for results side
const storeBusinessinResults = (business) => {
    business.forEach(function(val){
     
            var locationArray = val.location.display_address;
            var categoriesArray = val.categories;
            var businessName = `<h1 class="business-title" id="biz-title">${val.name}</h1>`;
            var businessCategories = `<p id="biz-categories">${printCategories(categoriesArray)}</p>`;
            var businessLocation = `<p id="biz-location">${printLocation(locationArray)}</p>`;
            var businessImage = `<p><img id="biz-img" class="img-contain" src=${val.image_url}></p>`;
            var businessRating = `<p>Rating: ${val.rating}</p>`;
            var saveBusiness = `<button class="save-button generic-button" onclick="saveBusiness(this, bizSearchResults)">Save this place.</button>`;
            var navigateButton = `<button class="navigate-button generic-button" onclick="openBusinessInMaps(this)"><i class="far fa-map"></i></button>`;
                //
            return ($("#result .content").append(`<div class="businesses" data-bizid=${val.id}>${businessName}${businessCategories}${businessLocation}${businessImage}${businessRating}${saveBusiness}${navigateButton}</div>`))
        
    })
    return
}

// display items from local storage for saved side
const storeBusinessinSaved = (bizArray) => {
    bizArray.forEach(function(i){
        var businessName = `<h1 class="business-title">${i.name}</h1>`;
        var businessCategories = `<p>${i.categories}</p>`;
        var businessLocation = `<p>${i.location}</p>`;
        var businessImage = `<p><img class="img-contain" src=${i.img}></p>`;
        var removeBusiness = `<button class="remove-button generic-button" onclick="removeBusiness(this)">Remove from saved.</button>`;
        var navigateButton = `<button class="navigate-button generic-button" onclick="openSavedBusinessInMaps(this)" data-location="${i.location}"><i class="far fa-map"></i></button>`;
        return ($("#saved .content").append(`<div class="businesses" data-bizid="${i.id}">${businessName}${businessCategories}${businessLocation}${businessImage}${removeBusiness}${navigateButton}</div>`))
    })
}



// get items in local storage, return array
const getSavedBusinesses = () => {
    var savedBusinesses = [];
    if ('businesses' in localStorage){
        savedBusinesses = JSON.parse(localStorage.getItem('businesses'));
    }
    return savedBusinesses
}
storeBusinessinSaved(getSavedBusinesses());

// for dev... clear localstorage
const clearLocalStorage = () => {
    localStorage.clear();
    return ('local storage cleared')
}

//add business to localstorage & display in save column
const saveBusiness = (event, searchResults) => {
    var data = {
        'id' : event.parentElement.getAttribute('data-bizid'),
        'name': event.parentElement.querySelector('#biz-title').innerHTML,
        'categories': event.parentElement.querySelector('#biz-categories').innerHTML,
        'location': event.parentElement.querySelector('#biz-location').innerHTML,
        'img': event.parentElement.querySelector('#biz-img').getAttribute('src')
    }
    var savedBusinesses = getSavedBusinesses();
    var doesBizExist = savedBusinesses.filter(index => index.id == data.id);
    if (doesBizExist.length <= 0){
        //if doesnt exists then save it.
        savedBusinesses.push(data); 
        storeBusinessinSaved(Array(data))//need to convert to array to fit the function
        localStorage.setItem('businesses', JSON.stringify(savedBusinesses));
    }else{
        console.log('already saved this place')
    }
}


const removeBusiness = (domElement) => {
    var businessToRemove = domElement.parentElement;
    var localStorageArray = getSavedBusinesses();
    var doesBizExist = localStorageArray.filter(index => index.id != businessToRemove.getAttribute('data-bizid'));
    
    businessToRemove.remove();
    localStorage.setItem('businesses', JSON.stringify(doesBizExist))
}

const openBusinessInMaps = (event) => {
    console.log(event)
    window.open(`https://www.google.com/maps/place/${event.parentElement.querySelector('#biz-location').innerHTML}`)
}
const openSavedBusinessInMaps = (event) => {
    window.open(`https://www.google.com/maps/place/${event.getAttribute('data-location')}`)
}

      </script>
      
      
    
    
    
    
</body>
</html>